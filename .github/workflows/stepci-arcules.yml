name: Arcules API Audit Report

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  arcules-audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install jq and curl
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Get Arcules token
        id: get_token
        run: |
          response=$(curl -s -X POST "https://msapi.jp.arcules.com/v1/login" \
            -H "accept: application/json" \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"${{ secrets.ARCULES_EMAIL }}\",\"password\":\"${{ secrets.ARCULES_PASS }}\"}")
          echo "Response: $response"
          token=$(echo "$response" | jq -r '.jwtToken')
          echo "token=$token" >> $GITHUB_OUTPUT

      - name: Call Arcules APIs and generate HTML report
        run: |
          TOKEN=${{ steps.get_token.outputs.token }}
          EMAIL=${{ secrets.ARCULES_EMAIL }}
          
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "Failed to get token, aborting."
            exit 1
          fi

          echo "<html><body><h1>Arcules API Audit Report</h1>" > report.html
          # authentication section
          echo "<h2>Authentication</h2>" >> report.html
          echo "<p>Email: $EMAIL</p>" >> report.html
          echo "<p>Password: ***</p>" >> report.html
          echo "<p>Status: OK</p>" >> report.html

          # devices を先に取得
          devices_json=$(curl -s -H "Authorization: Bearer $TOKEN" https://msapi.jp.arcules.com/v1/devices)
          echo "<h2>Devices</h2>" >> report.html
          echo "<pre>$devices_json</pre>" >> report.html

          # devices の id を使って thumbnails を取得
          echo "<h2>Thumbnails</h2>" >> report.html
          device_ids=$(echo "$devices_json" | jq -r '.[].id')
          for id in $device_ids; do
            thumbnail_url="https://msapi.jp.arcules.com/v1/thumbnail/${id}/live"
            base64_img=$(curl -s -H "Authorization: Bearer $TOKEN" -H "accept: image/jpeg" "$thumbnail_url" | base64)
            if [ -n "$base64_img" ]; then
              echo "<div><strong>$id</strong><br><img src='data:image/jpeg;base64,$base64_img'></div>" >> report.html
            else
              echo "<div><strong>$id</strong><br><span style='color:red'>Thumbnail not found</span></div>" >> report.html
            fi
          done

          # 他のエンドポイント
          for ep in "organizations" "sites"; do
            url="https://msapi.jp.arcules.com/v1/$ep"
            http_status=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $TOKEN" "$url")
            echo "<h2>$ep</h2>" >> report.html
            echo "<p>HTTP Status: $http_status</p>" >> report.html
            if [ "$http_status" -eq 200 ]; then
              json=$(curl -s -H "Authorization: Bearer $TOKEN" "$url" | jq '.')
              echo "<pre>$json</pre>" >> report.html
            else
              echo "<p><span style='color:red'>Error or not found</span></p>" >> report.html
            fi
          done

          echo "</body></html>" >> report.html

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        with:
          name: arcules-api-audit-report
          path: report.html
